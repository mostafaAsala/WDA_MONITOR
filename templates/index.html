<!-- Main HTML structure for WDA Monitor application -->
<!DOCTYPE html>
<html lang="en">
<head>
	<!-- Meta tags for proper character encoding and responsive viewport -->
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>WDA Monitor</title>
	
	<!-- Essential CSS Dependencies -->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
	<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
	
	<!-- Essential JavaScript Dependencies -->
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
	<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
	<!-- Custom CSS Styles -->

	<style>
		.badge {
			font-size: 0.85rem;
			padding: 0.35em 0.65em;
			font-weight: 500;
		}
		.badge.bg-danger {
			background-color: #dc3545 !important;
		}
		.badge.bg-primary {
			background-color: #0d6efd !important;
		}
		.badge.bg-secondary {
			background-color: #6c757d !important;
		}
		.status-badge {
			min-width: 90px;
			text-align: center;
		}
		.file-list {
			max-height: 400px;
			overflow-y: auto;
			overflow-x: auto;
		}
		.table {
			margin-bottom: 0;
			white-space: nowrap;
		}
		.table th {
			background-color: #f8f9fa;
			border-bottom: 2px solid #dee2e6;
			position: sticky;
			top: 0;
			z-index: 1;
		}
		.table td {
			vertical-align: middle;
		}
		.table tr:hover {
			background-color: rgba(0,0,0,.03);
		}
		.table td:nth-child(3) {
			white-space: normal;
			min-width: 200px;
		}

		.stop-date-input {
			max-width: 250px;
		}
		.input-group .btn {
			z-index: 0;
		}

		.expired-file {
			text-decoration: line-through;
			color: #6c757d;
		}

		.chart-loading {
			position: absolute;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background: rgba(255, 255, 255, 0.8);
			display: none;
			align-items: center;
			justify-content: center;
			z-index: 10;
		}

		.position-relative {
			position: relative;
		}

		.chart-container {
			min-height: 400px;
			width: 100%;
			background: white;
			border-radius: 8px;
			box-shadow: 0 2px 4px rgba(0,0,0,0.05);
			padding: 15px;
		}

		.container-fluid {
			padding: 0 2rem;
			width: 100%;
			max-width: 1400px;
		}
		.navbar {
			box-shadow: 0 2px 4px rgba(0,0,0,0.1);
		}
		.navbar-brand, .nav-link {
			font-weight: 500;
		}
		.nav-link {
			transition: color 0.3s ease;
		}
		.nav-link:hover {
			color: rgba(255,255,255,0.9) !important;
		}
		.card {
			margin-bottom: 2rem;
			border-radius: 0.5rem;
			box-shadow: 0 2px 4px rgba(0,0,0,0.05);
		}
		.card-header {
			background-color: #f8f9fa;
			border-bottom: 1px solid rgba(0,0,0,0.05);
			padding: 1rem 1.5rem;
		}
		.card-body {
			padding: 1.5rem;
		}
		.file-list {
			max-height: 400px;
			overflow-y: auto;
		}
		.loading {
			position: fixed;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background: rgba(255,255,255,0.9);
			display: none;
			align-items: center;
			justify-content: center;
			z-index: 2000;
		}
		#notification {
			position: fixed;
			top: 20px;
			right: 20px;
			z-index: 1000;
			display: none;
		}
	</style>

</head>
<body>
	<div id="notification" class="alert alert-success animate__animated animate__fadeInRight"></div>
	<div class="loading">
		<div class="spinner-border text-primary" role="status">
			<span class="visually-hidden">Loading...</span>
		</div>
	</div>

	<!-- Navigation Bar -->
	<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
		<div class="container-fluid">
			<a class="navbar-brand" href="/">WDA Monitor</a>
			<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
				<span class="navbar-toggler-icon"></span>
			</button>
			<div class="collapse navbar-collapse" id="navbarNav">
				<ul class="navbar-nav">
					<li class="nav-item">
						<a class="nav-link active" href="/">Home</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" href="/visuals">Visualizations</a>
					</li>
				</ul>
			</div>
		</div>
	</nav>

	<!-- Login Modal -->
	<div class="modal fade" id="loginModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Login Required</h5>
				</div>
				<div class="modal-body">
					<form id="loginForm">
						<div class="mb-3">
							<label for="username" class="form-label">Username</label>
							<input type="text" class="form-control" id="username" required>
						</div>
						<div class="mb-3">
							<label for="password" class="form-label">Password</label>
							<input type="password" class="form-control" id="password" required>
						</div>
						<div class="text-danger mb-3" id="loginError" style="display: none;">
							Invalid username or password
						</div>
						<button type="submit" class="btn btn-primary">Login</button>
					</form>
				</div>
			</div>
		</div>
	</div>

	<div class="container-fluid mt-5">
		<div class="text-center mb-5">
			<h1 class="display-4 animate__animated animate__fadeIn">WDA Monitor</h1>
		</div>
		
		<div class="row justify-content-center">
			<div class="col-md-10">
				<!-- File Upload Section -->
				<div class="card mb-4 animate__animated animate__fadeInUp">
					<div class="card-header">Upload File</div>
					<div class="card-body">
						<form id="uploadForm" enctype="multipart/form-data">
							<div class="mb-3">
								<input type="file" class="form-control" id="fileInput" accept=".txt">
							</div>
							<button type="submit" class="btn btn-primary">
								<span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
								Upload
							</button>
						</form>
					</div>
				</div>

				<!-- File List Section -->
				<div class="card mb-4 animate__animated animate__fadeInUp" style="animation-delay: 0.2s">
					<div class="card-header d-flex justify-content-between align-items-center">
						<span>Files</span>
						<button id="refreshList" class="btn btn-sm btn-outline-secondary">
							<i class="fas fa-sync-alt"></i> Refresh
						</button>
					</div>
					<div class="card-body">
						<div class="file-list">
							<table class="table table-hover">
								<thead>
									<tr>
										<th>Select</th>
										<th>ID</th>
										<th>File Name</th>
										<th>Upload Date</th>
										<th>Last Check Date</th>
										<th>Stop Monitor Date</th>
										<th>Status</th>
										<th>Actions</th>
									</tr>
								</thead>
								<tbody id="fileList">
									{% for file in files %}
									<tr class="animate__animated animate__fadeIn">
										<td>
											<input class="form-check-input file-checkbox" type="checkbox" value="{{ file }}" id="file-{{ loop.index }}">
										</td>
										{% set db_file = db_files|selectattr("file_name", "equalto", file)|first|default(None) %}
										<td>{{ db_file.id if db_file else '-' }}</td>
										<td>
											<label class="form-check-label 
												{% if db_file and db_file.stop_monitor_date and db_file.stop_monitor_date|string != 'NaT' 
												and db_file.stop_monitor_date.date() < today %} expired-file {% endif %}" 
												for="file-{{ loop.index }}">{{ file }}
											</label>
										</td>
										<td>{{ db_file.upload_date.date()  if db_file and db_file.upload_date else 'Not uploaded' }}</td>
										<td>{{ db_file.last_check_date.date()  if db_file and db_file.last_check_date else 'Not checked' }}</td>
										<td>
											<div class="input-group">
												<input type="date" class="form-control form-control-sm stop-date-input" 
													value="{{ db_file.stop_monitor_date.date()  if db_file and db_file.stop_monitor_date else '' }}"
													data-filename="{{ file }}">
												<button class="btn btn-outline-primary btn-sm update-stop-date" type="button">Update</button>
											</div>
										</td>
										<td>
											{% if db_file and db_file.stop_monitor_date and db_file.stop_monitor_date|string != 'NaT' 
											and db_file.stop_monitor_date.date() < today %}
												<span class="badge bg-danger">Expired</span>
											{% else %}
												<span class="badge bg-secondary status-badge" data-filename="{{ file }}">Idle</span>
											{% endif %}
										</td>
										<td>
											<button class="btn btn-danger btn-sm delete-btn" data-filename="{{ file }}">Delete</button>
										</td>
									</tr>
									{% endfor %}
								</tbody>
							</table>
						</div>
					</div>
				</div>

				<!-- Status Check Section -->
				<div class="card mb-4 animate__animated animate__fadeInUp" style="animation-delay: 0.4s">
					<div class="card-header">Status Check</div>
					<div class="card-body">
						<div class="form-check mb-3">
							<input class="form-check-input" type="checkbox" id="ignoreDate" checked>
							<label class="form-check-label" for="ignoreDate">
								Ignore Date
							</label>
						</div>
						<button id="checkStatus" class="btn btn-primary me-2">Check Status</button>
						<button id="checkValidParts" class="btn btn-warning me-2">Check Valid Parts</button>
						<button id="downloadResults" class="btn btn-success">Download Results</button>
					</div>
				</div>
			</div>
		</div>
	</div>

						


					</div>


</div>


			
</div>

		</div>
	</div>
	<script>
		let csvData = [];
		
		// Status polling function
		function pollFileStatus() {
			fetch('/get-file-status')
				.then(response => response.json())
				.then(statusData => {
					// Update status badges
					document.querySelectorAll('.status-badge').forEach(badge => {
						const fileName = badge.dataset.filename;
						if (statusData[fileName]) {
							badge.className = `badge ${statusData[fileName] === 'In Progress' ? 'bg-primary' : 'bg-secondary'} status-badge`;
							badge.textContent = statusData[fileName];
						}
					});
				})
				.catch(error => console.error('Error polling status:', error));
		}

		// Start polling when page loads
		let statusPollInterval;
		document.addEventListener('DOMContentLoaded', () => {
			statusPollInterval = setInterval(pollFileStatus, 60000); // Poll every 2 seconds
		});

		// Cleanup on page unload
		window.addEventListener('beforeunload', async (event) => {
			// Clear polling interval
			clearInterval(statusPollInterval);
			
			// Reset status for all files
			const files = Array.from(document.querySelectorAll('.status-badge')).map(badge => badge.dataset.filename);
			if (files.length > 0) {
				try {
					await fetch('/reset-file-status', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json'
						},
						body: JSON.stringify({ files })
					});
				} catch (error) {
					console.error('Error resetting file status:', error);
				}
			}
		});

		function showNotification(message, type = 'success') {
			const notification = document.getElementById('notification');
			notification.className = `alert alert-${type} animate__animated animate__fadeInRight`;
			notification.textContent = message;
			notification.style.display = 'block';
			setTimeout(() => {
				notification.classList.remove('animate__fadeInRight');
				notification.classList.add('animate__fadeOutRight');
				setTimeout(() => {
					notification.style.display = 'none';
				}, 500);
			}, 3000);
		}

		function showLoading() {
			document.querySelector('.loading').style.display = 'flex';
		}

		function hideLoading() {
			document.querySelector('.loading').style.display = 'none';
		}

		

		// Login functionality
		const loginModal = new bootstrap.Modal(document.getElementById('loginModal'), {
			backdrop: 'static',
			keyboard: false
		});

		function checkLoginStatus() {
			const loginData = localStorage.getItem('loginData');
			if (loginData) {
				const { timestamp } = JSON.parse(loginData);
				const oneDayInMs = 24 * 60 * 60 * 1000;
				if (Date.now() - timestamp < oneDayInMs) {
					return true;
				}
				localStorage.removeItem('loginData');
			}
			return false;
		}

		// Event Listeners
		document.addEventListener('DOMContentLoaded', () => {
			if (checkLoginStatus()) {
				document.querySelector('.container-fluid').style.display = 'block';
				// Start status polling
				statusPollInterval = setInterval(pollFileStatus, 60000);
			} else {
				loginModal.show();
			}
		});

		// Update login form handler to start polling after successful login
		document.getElementById('loginForm').addEventListener('submit', (e) => {
			e.preventDefault();
			const username = document.getElementById('username').value;
			const password = document.getElementById('password').value;
			
			if (username === 'WDA' && password === 'admin') {
				localStorage.setItem('loginData', JSON.stringify({
					timestamp: Date.now()
				}));
				loginModal.hide();
				document.querySelector('.container-fluid').style.display = 'block';
				// Start status polling after successful login
				statusPollInterval = setInterval(pollFileStatus, 60000); // Poll every 2 seconds
			} else {
				document.getElementById('loginError').style.display = 'block';
			}
		});

		// File operations event listeners
		document.getElementById('uploadForm').addEventListener('submit', async (e) => {
			e.preventDefault();
			const formData = new FormData();
			const fileInput = document.getElementById('fileInput');
			const submitBtn = e.target.querySelector('button[type="submit"]');
			const spinner = submitBtn.querySelector('.spinner-border');
			
			formData.append('file', fileInput.files[0]);
			
			try {
				spinner.classList.remove('d-none');
				submitBtn.disabled = true;
				showLoading();

				const response = await fetch('/upload', {
					method: 'POST',
					body: formData
				});
				const result = await response.json();
				
				if (response.ok) {
					showNotification('File uploaded successfully');
					location.reload();
				} else {
					showNotification(result.error, 'danger');
				}
			} catch (error) {
				showNotification('Error uploading file', 'danger');
			} finally {
				spinner.classList.add('d-none');
				submitBtn.disabled = false;
				hideLoading();
			}
		});

		document.querySelectorAll('.delete-btn').forEach(button => {
			button.addEventListener('click', async () => {
				const filename = button.dataset.filename;
				if (confirm(`Delete ${filename}?`)) {
					try {
						showLoading();
						const response = await fetch(`/delete/${filename}`, {
							method: 'POST'
						});
						const result = await response.json();
						
						if (response.ok) {
							button.closest('.list-group-item').classList.add('animate__fadeOutRight');
							setTimeout(() => {
								location.reload();
							}, 500);
							showNotification('File deleted successfully');
						} else {
							showNotification(result.error, 'danger');
						}
					} catch (error) {
						showNotification('Error deleting file', 'danger');
					} finally {
						hideLoading();
					}
				}
			})
		});




		




		// Function to handle data updates






		// Refresh list handler
		document.getElementById('refreshList').addEventListener('click', async () => {
			try {
				showLoading();
				const [filesResponse, dbFilesResponse, statusResponse] = await Promise.all([
					fetch('/refresh-files'),
					fetch('/get-db-files'),
					fetch('/get-file-status')
				]);
				
				const filesResult = await filesResponse.json();
				const dbFilesResult = await dbFilesResponse.json();
				const statusData = await statusResponse.json();
				
				if (filesResponse.ok && dbFilesResult.status === 'success') {
					const fileList = document.getElementById('fileList');
					fileList.innerHTML = '';
					
					filesResult.files.forEach((file, index) => {
						const dbFileInfo = dbFilesResult.files.find(dbFile => dbFile.file_name === file);
						const currentStatus = statusData[file] || 'Idle';
						const row = document.createElement('tr');
						row.className = 'animate__animated animate__fadeIn';
						row.innerHTML = `
							<td>
								<input class="form-check-input file-checkbox" type="checkbox" value="${file}" id="file-${index}">
							</td>
							<td>${dbFileInfo ? dbFileInfo.id : '-'}</td>
							<td>
								<label class="form-check-label ${dbFileInfo && dbFileInfo.stop_monitor_date ? (new Date(dbFileInfo.stop_monitor_date) < new Date().setHours(0,0,0,0) ? 'expired-file' : '') : ''}" for="file-${index}">${file}</label>
							</td>
							<td>${dbFileInfo && dbFileInfo.upload_date ? new Date(dbFileInfo.upload_date).toLocaleDateString('en-CA') : 'Not uploaded'}</td>
							<td>${dbFileInfo && dbFileInfo.last_check_date ? new Date(dbFileInfo.last_check_date).toLocaleDateString('en-CA') : 'Not checked'}</td>
							<td>
								<div class="input-group">
									<input type="date" class="form-control form-control-sm stop-date-input" 
										value="${dbFileInfo && dbFileInfo.stop_monitor_date ? dbFileInfo.stop_monitor_date.split('T')[0] : ''}"
										data-filename="${file}">
									<button class="btn btn-outline-primary btn-sm update-stop-date" type="button">Update</button>
								</div>
							</td>
							<td>
								${dbFileInfo && dbFileInfo.stop_monitor_date && new Date(dbFileInfo.stop_monitor_date) < new Date().setHours(0,0,0,0) 
									? '<span class="badge bg-danger">Expired</span>' 
									: `<span class="badge ${currentStatus === 'In Progress' ? 'bg-primary' : 'bg-secondary'} status-badge" data-filename="${file}">${currentStatus}</span>`}
							</td>
							<td>
								<button class="btn btn-danger btn-sm delete-btn" data-filename="${file}">Delete</button>
							</td>
						`;
						fileList.appendChild(row);
					});

					// Reattach delete button event listeners
					document.querySelectorAll('.delete-btn').forEach(button => {
						button.addEventListener('click', async () => {
							const filename = button.dataset.filename;
							if (confirm(`Delete ${filename}?`)) {
								try {
									showLoading();
									const response = await fetch(`/delete/${filename}`, {
										method: 'POST'
									});
									const result = await response.json();
									
									if (response.ok) {
										button.closest('tr').classList.add('animate__fadeOutRight');
										setTimeout(() => {
											location.reload();
										}, 500);
										showNotification('File deleted successfully');
									} else {
										showNotification(result.error, 'danger');
									}
								} catch (error) {
									showNotification('Error deleting file', 'danger');
								} finally {
									hideLoading();
								}
							}
						});
					});
				} else {
					showNotification(filesResult.error || dbFilesResult.message, 'danger');
				}
			} catch (error) {
				showNotification('Error refreshing files', 'danger');
			} finally {
				hideLoading();
			}
		});

		// Initialize data loading when DOM is ready
		//document.addEventListener('DOMContentLoaded', loadCSVData);

		// File Upload Handler
		document.getElementById('uploadForm').addEventListener('submit', async (e) => {
			e.preventDefault();
			const formData = new FormData();
			const fileInput = document.getElementById('fileInput');
			const submitBtn = e.target.querySelector('button[type="submit"]');
			const spinner = submitBtn.querySelector('.spinner-border');
			
			formData.append('file', fileInput.files[0]);
			
			try {
				spinner.classList.remove('d-none');
				submitBtn.disabled = true;
				showLoading();

				const response = await fetch('/upload', {
					method: 'POST',
					body: formData
				});
				const result = await response.json();
				
				if (response.ok) {
					showNotification('File uploaded successfully');
					location.reload();
				} else {
					showNotification(result.error, 'danger');
				}
			} catch (error) {
				showNotification('Error uploading file', 'danger');
			} finally {
				spinner.classList.add('d-none');
				submitBtn.disabled = false;
				hideLoading();
			}
		});

		// Delete File Handler
		document.querySelectorAll('.delete-btn').forEach(button => {
			button.addEventListener('click', async () => {
				const filename = button.dataset.filename;
				if (confirm(`Delete ${filename}?`)) {
					try {
						showLoading();
						const response = await fetch(`/delete/${filename}`, {
							method: 'POST'
						});
						const result = await response.json();
						
						if (response.ok) {
							button.closest('tr').classList.add('animate__fadeOutRight');
							setTimeout(() => {
								location.reload();
							}, 500);
							showNotification('File deleted successfully');
						} else {
							showNotification(result.error, 'danger');
						}
					} catch (error) {
						showNotification('Error deleting file', 'danger');
					} finally {
						hideLoading();
					}
				}
			});
		});

		// Status Check Handler
		document.getElementById('checkStatus').addEventListener('click', async () => {
			const selectedFiles = Array.from(document.querySelectorAll('.file-checkbox:checked')).map(cb => cb.value);
			const ignoreDate = document.getElementById('ignoreDate').checked;

			if (selectedFiles.length === 0) {
				showNotification('Please select files to check', 'warning');
				return;
			}

			try {
				showLoading();
				const response = await fetch('/status', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({
						files: selectedFiles,
						ignore_date: ignoreDate
					})
				});
				const result = await response.json();
				
				if (response.ok) {
					showNotification('Status check completed successfully');
				} else {
					showNotification(result.error, 'danger');
				}
			} catch (error) {
				showNotification('Error checking status', 'danger');
			} finally {
				hideLoading();
			}
		});


		// Download Results Handler
		document.getElementById('downloadResults').addEventListener('click', async () => {
			const selectedFiles = Array.from(document.querySelectorAll('.file-checkbox:checked')).map(cb => cb.value);

			try {
				showLoading();
				const response = await fetch('/download', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({
						files: selectedFiles
					})
				});
				
				if (response.ok) {
					const blob = await response.blob();
					const url = window.URL.createObjectURL(blob);
					const a = document.createElement('a');
					a.href = url;
					a.download = 'results.csv';
					document.body.appendChild(a);
					a.click();
					window.URL.revokeObjectURL(url);
					showNotification('Results downloaded successfully');
					//loadCSVData();
				} else {
					const result = await response.json();
					showNotification(result.error, 'danger');
				}
			} catch (error) {
				showNotification('Error downloading results', 'danger');
			} finally {
				hideLoading();
			}
		});

		// Check Valid Parts Handler
		document.getElementById('checkValidParts').addEventListener('click', async () => {
			const selectedFiles = Array.from(document.querySelectorAll('.file-checkbox:checked')).map(cb => cb.value);

			try {
				showLoading();
				const response = await fetch('/check-valid-parts', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({
						files: selectedFiles
					})
				});
				const result = await response.json();
				
				if (response.ok) {
					const stats = result.data;
					const message = `Validation completed: ${stats.valid_parts} valid parts, ${stats.invalid_parts} invalid parts out of ${stats.total_parts} total parts`;
					showNotification(message);
				} else {
					showNotification(result.error, 'danger');
				}
			} catch (error) {
				showNotification('Error checking valid parts', 'danger');
			} finally {
				hideLoading();
			}
		});

		// Stop Monitor Date Update Handler
		document.addEventListener('click', (e) => {
			if (e.target.classList.contains('update-stop-date')) {
				const dateInput = e.target.previousElementSibling;
				const fileName = dateInput.dataset.filename;
				const stopDate = dateInput.value;

				if (!stopDate) {
					showNotification('Please select a date', 'warning');
					return;
				}

				try {
					showLoading();
					fetch('/update-stop-date', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json'
						},
						body: JSON.stringify({
							file_name: fileName,
							stop_date: stopDate
						})
					})
					.then(response => response.json())
					.then(result => {
						if (result.status === 'success') {
							showNotification('Stop monitor date updated successfully');
						} else {
							showNotification(result.error, 'danger');
						}
					})
					.catch(error => {
						showNotification('Error updating stop monitor date', 'danger');
					})
					.finally(() => {
						hideLoading();
					});
				} catch (error) {
					hideLoading();
					showNotification('Error updating stop monitor date', 'danger');
				}
			}
		});

	</script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
</body>
</html>