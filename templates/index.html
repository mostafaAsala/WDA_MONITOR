<!-- Main HTML structure for WDA Monitor application -->
<!DOCTYPE html>
<html lang="en">
<head>
	<!-- Meta tags for proper character encoding and responsive viewport -->
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>WDA Monitor</title>
	
	<!-- Essential CSS Dependencies -->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
	<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
	
	<!-- Essential JavaScript Dependencies -->
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
	<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
	<!-- Custom CSS Styles -->

	<style>
		.chart-loading {
			position: absolute;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background: rgba(255, 255, 255, 0.8);
			display: none;
			align-items: center;
			justify-content: center;
			z-index: 10;
		}

		.position-relative {
			position: relative;
		}

		.chart-container {
			min-height: 400px;
			width: 100%;
			background: white;
			border-radius: 8px;
			box-shadow: 0 2px 4px rgba(0,0,0,0.05);
			padding: 15px;
		}

		.container-fluid {
			padding: 0 2rem;
			width: 100%;
			max-width: 1400px;
		}
		.navbar {
			box-shadow: 0 2px 4px rgba(0,0,0,0.1);
		}
		.navbar-brand, .nav-link {
			font-weight: 500;
		}
		.nav-link {
			transition: color 0.3s ease;
		}
		.nav-link:hover {
			color: rgba(255,255,255,0.9) !important;
		}
		.card {
			margin-bottom: 2rem;
			border-radius: 0.5rem;
			box-shadow: 0 2px 4px rgba(0,0,0,0.05);
		}
		.card-header {
			background-color: #f8f9fa;
			border-bottom: 1px solid rgba(0,0,0,0.05);
			padding: 1rem 1.5rem;
		}
		.card-body {
			padding: 1.5rem;
		}
		.file-list {
			max-height: 400px;
			overflow-y: auto;
		}
		.loading {
			position: fixed;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background: rgba(255,255,255,0.9);
			display: none;
			align-items: center;
			justify-content: center;
			z-index: 2000;
		}
		#notification {
			position: fixed;
			top: 20px;
			right: 20px;
			z-index: 1000;
			display: none;
		}
	</style>

</head>
<body>
	<div id="notification" class="alert alert-success animate__animated animate__fadeInRight"></div>
	<div class="loading">
		<div class="spinner-border text-primary" role="status">
			<span class="visually-hidden">Loading...</span>
		</div>
	</div>

	<!-- Navigation Bar -->
	<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
		<div class="container-fluid">
			<a class="navbar-brand" href="/">WDA Monitor</a>
			<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
				<span class="navbar-toggler-icon"></span>
			</button>
			<div class="collapse navbar-collapse" id="navbarNav">
				<ul class="navbar-nav">
					<li class="nav-item">
						<a class="nav-link active" href="/">Home</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" href="/visuals">Visualizations</a>
					</li>
				</ul>
			</div>
		</div>
	</nav>

	<!-- Login Modal -->
	<div class="modal fade" id="loginModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Login Required</h5>
				</div>
				<div class="modal-body">
					<form id="loginForm">
						<div class="mb-3">
							<label for="username" class="form-label">Username</label>
							<input type="text" class="form-control" id="username" required>
						</div>
						<div class="mb-3">
							<label for="password" class="form-label">Password</label>
							<input type="password" class="form-control" id="password" required>
						</div>
						<div class="text-danger mb-3" id="loginError" style="display: none;">
							Invalid username or password
						</div>
						<button type="submit" class="btn btn-primary">Login</button>
					</form>
				</div>
			</div>
		</div>
	</div>

	<div class="container-fluid mt-5">
		<div class="text-center mb-5">
			<h1 class="display-4 animate__animated animate__fadeIn">WDA Monitor</h1>
		</div>
		
		<div class="row justify-content-center">
			<div class="col-md-8">
				<!-- File Upload Section -->
				<div class="card mb-4 animate__animated animate__fadeInUp">
					<div class="card-header">Upload File</div>
					<div class="card-body">
						<form id="uploadForm" enctype="multipart/form-data">
							<div class="mb-3">
								<input type="file" class="form-control" id="fileInput" accept=".txt">
							</div>
							<button type="submit" class="btn btn-primary">
								<span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
								Upload
							</button>
						</form>
					</div>
				</div>

				<!-- File List Section -->
				<div class="card mb-4 animate__animated animate__fadeInUp" style="animation-delay: 0.2s">
					<div class="card-header d-flex justify-content-between align-items-center">
						<span>Files</span>
						<button id="refreshList" class="btn btn-sm btn-outline-secondary">
							<i class="fas fa-sync-alt"></i> Refresh
						</button>
					</div>
					<div class="card-body">
						<div class="file-list">
							<div class="list-group" id="fileList">
								{% for file in files %}
								<div class="list-group-item animate__animated animate__fadeIn">
									<div class="form-check d-flex justify-content-between align-items-center">
										<div>
											<input class="form-check-input file-checkbox" type="checkbox" value="{{ file }}" id="file-{{ loop.index }}">
											<label class="form-check-label" for="file-{{ loop.index }}">
												{{ file }}
											</label>
										</div>
										<button class="btn btn-danger btn-sm delete-btn" data-filename="{{ file }}">Delete</button>
									</div>
								</div>
								{% endfor %}
							</div>
						</div>
					</div>
				</div>

				<!-- Status Check Section -->
				<div class="card mb-4 animate__animated animate__fadeInUp" style="animation-delay: 0.4s">
					<div class="card-header">Status Check</div>
					<div class="card-body">
						<div class="form-check mb-3">
							<input class="form-check-input" type="checkbox" id="ignoreDate" checked>
							<label class="form-check-label" for="ignoreDate">
								Ignore Date
							</label>
						</div>
						<button id="checkStatus" class="btn btn-primary me-2">Check Status</button>
						<button id="downloadResults" class="btn btn-success">Download Results</button>
					</div>
				</div>
			</div>
		</div>
	</div>

						


					</div>


</div>


			
</div>

		</div>
	</div>
	<script>
		let csvData = [];

		function showNotification(message, type = 'success') {
			const notification = document.getElementById('notification');
			notification.className = `alert alert-${type} animate__animated animate__fadeInRight`;
			notification.textContent = message;
			notification.style.display = 'block';
			setTimeout(() => {
				notification.classList.remove('animate__fadeInRight');
				notification.classList.add('animate__fadeOutRight');
				setTimeout(() => {
					notification.style.display = 'none';
				}, 500);
			}, 3000);
		}

		function showLoading() {
			document.querySelector('.loading').style.display = 'flex';
		}

		function hideLoading() {
			document.querySelector('.loading').style.display = 'none';
		}

		

		// Login functionality
		const loginModal = new bootstrap.Modal(document.getElementById('loginModal'), {
			backdrop: 'static',
			keyboard: false
		});

		function checkLoginStatus() {
			const loginData = localStorage.getItem('loginData');
			if (loginData) {
				const { timestamp } = JSON.parse(loginData);
				const oneDayInMs = 24 * 60 * 60 * 1000;
				if (Date.now() - timestamp < oneDayInMs) {
					return true;
				}
				localStorage.removeItem('loginData');
			}
			return false;
		}

		// Event Listeners
		document.addEventListener('DOMContentLoaded', () => {
			if (checkLoginStatus()) {
				document.querySelector('.container-fluid').style.display = 'block';
				//loadCSVData();
			} else {
				loginModal.show();
			}
		});

		document.getElementById('loginForm').addEventListener('submit', (e) => {
			e.preventDefault();
			const username = document.getElementById('username').value;
			const password = document.getElementById('password').value;
			
			if (username === 'WDA' && password === 'admin') {
				localStorage.setItem('loginData', JSON.stringify({
					timestamp: Date.now()
				}));
				loginModal.hide();
				document.querySelector('.container-fluid').style.display = 'block';
				//loadCSVData();
			} else {
				document.getElementById('loginError').style.display = 'block';
			}
		});

		// File operations event listeners
		document.getElementById('uploadForm').addEventListener('submit', async (e) => {
			e.preventDefault();
			const formData = new FormData();
			const fileInput = document.getElementById('fileInput');
			const submitBtn = e.target.querySelector('button[type="submit"]');
			const spinner = submitBtn.querySelector('.spinner-border');
			
			formData.append('file', fileInput.files[0]);
			
			try {
				spinner.classList.remove('d-none');
				submitBtn.disabled = true;
				showLoading();

				const response = await fetch('/upload', {
					method: 'POST',
					body: formData
				});
				const result = await response.json();
				
				if (response.ok) {
					showNotification('File uploaded successfully');
					location.reload();
				} else {
					showNotification(result.error, 'danger');
				}
			} catch (error) {
				showNotification('Error uploading file', 'danger');
			} finally {
				spinner.classList.add('d-none');
				submitBtn.disabled = false;
				hideLoading();
			}
		});

		document.querySelectorAll('.delete-btn').forEach(button => {
			button.addEventListener('click', async () => {
				const filename = button.dataset.filename;
				if (confirm(`Delete ${filename}?`)) {
					try {
						showLoading();
						const response = await fetch(`/delete/${filename}`, {
							method: 'POST'
						});
						const result = await response.json();
						
						if (response.ok) {
							button.closest('.list-group-item').classList.add('animate__fadeOutRight');
							setTimeout(() => {
								location.reload();
							}, 500);
							showNotification('File deleted successfully');
						} else {
							showNotification(result.error, 'danger');
						}
					} catch (error) {
						showNotification('Error deleting file', 'danger');
					} finally {
						hideLoading();
					}
				}
			})
		});




		




		// Function to handle data updates






		// Refresh list handler
		document.getElementById('refreshList').addEventListener('click', async () => {
			try {
				showLoading();
				const response = await fetch('/refresh-files');
				const result = await response.json();
				
				if (response.ok) {
					location.reload();
				} else {
					showNotification(result.error, 'danger');
				}
			} catch (error) {
				showNotification('Error refreshing files', 'danger');
			} finally {
				hideLoading();
			}
		});

		// Initialize data loading when DOM is ready
		//document.addEventListener('DOMContentLoaded', loadCSVData);

		// File Upload Handler
		document.getElementById('uploadForm').addEventListener('submit', async (e) => {
			e.preventDefault();
			const formData = new FormData();
			const fileInput = document.getElementById('fileInput');
			const submitBtn = e.target.querySelector('button[type="submit"]');
			const spinner = submitBtn.querySelector('.spinner-border');
			
			formData.append('file', fileInput.files[0]);
			
			try {
				spinner.classList.remove('d-none');
				submitBtn.disabled = true;
				showLoading();

				const response = await fetch('/upload', {
					method: 'POST',
					body: formData
				});
				const result = await response.json();
				
				if (response.ok) {
					showNotification('File uploaded successfully');
					location.reload();
				} else {
					showNotification(result.error, 'danger');
				}
			} catch (error) {
				showNotification('Error uploading file', 'danger');
			} finally {
				spinner.classList.add('d-none');
				submitBtn.disabled = false;
				hideLoading();
			}
		});

		// Delete File Handler
		document.querySelectorAll('.delete-btn').forEach(button => {
			button.addEventListener('click', async () => {
				const filename = button.dataset.filename;
				if (confirm(`Delete ${filename}?`)) {
					try {
						showLoading();
						const response = await fetch(`/delete/${filename}`, {
							method: 'POST'
						});
						const result = await response.json();
						
						if (response.ok) {
							button.closest('.list-group-item').classList.add('animate__fadeOutRight');
							setTimeout(() => {
								location.reload();
							}, 500);
							showNotification('File deleted successfully');
						} else {
							showNotification(result.error, 'danger');
						}
					} catch (error) {
						showNotification('Error deleting file', 'danger');
					} finally {
						hideLoading();
					}
				}
			});
		});

		// Status Check Handler
		document.getElementById('checkStatus').addEventListener('click', async () => {
			const selectedFiles = Array.from(document.querySelectorAll('.file-checkbox:checked')).map(cb => cb.value);
			const ignoreDate = document.getElementById('ignoreDate').checked;

			try {
				showLoading();
				const response = await fetch('/status', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({
						files: selectedFiles,
						ignore_date: ignoreDate
					})
				});
				const result = await response.json();
				
				if (response.ok) {
					showNotification('Status check completed successfully');
					if (result.data) {
						//loadCSVData();
					}
				} else {
					showNotification(result.error, 'danger');
				}
			} catch (error) {
				showNotification('Error checking status', 'danger');
			} finally {
				hideLoading();
			}
		});

		// Download Results Handler
		document.getElementById('downloadResults').addEventListener('click', async () => {
			const selectedFiles = Array.from(document.querySelectorAll('.file-checkbox:checked')).map(cb => cb.value);

			try {
				showLoading();
				const response = await fetch('/download', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({
						files: selectedFiles
					})
				});
				
				if (response.ok) {
					const blob = await response.blob();
					const url = window.URL.createObjectURL(blob);
					const a = document.createElement('a');
					a.href = url;
					a.download = 'results.csv';
					document.body.appendChild(a);
					a.click();
					window.URL.revokeObjectURL(url);
					showNotification('Results downloaded successfully');
					//loadCSVData();
				} else {
					const result = await response.json();
					showNotification(result.error, 'danger');
				}
			} catch (error) {
				showNotification('Error downloading results', 'danger');
			} finally {
				hideLoading();
			}
		});


	</script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
</body>
</html>