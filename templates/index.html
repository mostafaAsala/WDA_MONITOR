<!-- Main HTML structure for WDA Monitor application -->
<!DOCTYPE html>
<html lang="en">
<head>
	<!-- Meta tags for proper character encoding and responsive viewport -->
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>WDA Monitor</title>
	
	<!-- Essential CSS Dependencies -->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
	<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
	
	<!-- Essential JavaScript Dependencies -->
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
	<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
	<!-- Custom CSS Styles -->

	<style>
		.chart-loading {
			position: absolute;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background: rgba(255, 255, 255, 0.8);
			display: none;
			align-items: center;
			justify-content: center;
			z-index: 10;
		}

		.position-relative {
			position: relative;
		}

		.chart-container {
			min-height: 400px;
			width: 100%;
			background: white;
			border-radius: 8px;
			box-shadow: 0 2px 4px rgba(0,0,0,0.05);
			padding: 15px;
		}

		.container-fluid {
			padding: 0 2rem;
			width: 100%;
			max-width: 1400px;
		}
		.navbar {
			box-shadow: 0 2px 4px rgba(0,0,0,0.1);
		}
		.navbar-brand, .nav-link {
			font-weight: 500;
		}
		.nav-link {
			transition: color 0.3s ease;
		}
		.nav-link:hover {
			color: rgba(255,255,255,0.9) !important;
		}
		.card {
			margin-bottom: 2rem;
			border-radius: 0.5rem;
			box-shadow: 0 2px 4px rgba(0,0,0,0.05);
		}
		.card-header {
			background-color: #f8f9fa;
			border-bottom: 1px solid rgba(0,0,0,0.05);
			padding: 1rem 1.5rem;
		}
		.card-body {
			padding: 1.5rem;
		}
		.file-list {
			max-height: 400px;
			overflow-y: auto;
		}
		.loading {
			position: fixed;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background: rgba(255,255,255,0.9);
			display: none;
			align-items: center;
			justify-content: center;
			z-index: 2000;
		}
		#notification {
			position: fixed;
			top: 20px;
			right: 20px;
			z-index: 1000;
			display: none;
		}
	</style>

</head>
<body>
	<div id="notification" class="alert alert-success animate__animated animate__fadeInRight"></div>
	<div class="loading">
		<div class="spinner-border text-primary" role="status">
			<span class="visually-hidden">Loading...</span>
		</div>
	</div>

	<!-- Navigation Bar -->
	<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
		<div class="container-fluid">
			<a class="navbar-brand" href="/">WDA Monitor</a>
			<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
				<span class="navbar-toggler-icon"></span>
			</button>
			<div class="collapse navbar-collapse" id="navbarNav">
				<ul class="navbar-nav">
					<li class="nav-item">
						<a class="nav-link active" href="/">Home</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" href="/visuals">Visualizations</a>
					</li>
				</ul>
			</div>
		</div>
	</nav>

	<!-- Login Modal -->
	<div class="modal fade" id="loginModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Login Required</h5>
				</div>
				<div class="modal-body">
					<form id="loginForm">
						<div class="mb-3">
							<label for="username" class="form-label">Username</label>
							<input type="text" class="form-control" id="username" required>
						</div>
						<div class="mb-3">
							<label for="password" class="form-label">Password</label>
							<input type="password" class="form-control" id="password" required>
						</div>
						<div class="text-danger mb-3" id="loginError" style="display: none;">
							Invalid username or password
						</div>
						<button type="submit" class="btn btn-primary">Login</button>
					</form>
				</div>
			</div>
		</div>
	</div>

	<div class="container-fluid mt-5">
		<div class="text-center mb-5">
			<h1 class="display-4 animate__animated animate__fadeIn">WDA Monitor</h1>
		</div>
		
		<div class="row justify-content-center">
			<div class="col-md-8">
				<!-- File Upload Section -->
				<div class="card mb-4 animate__animated animate__fadeInUp">
					<div class="card-header">Upload File</div>
					<div class="card-body">
						<form id="uploadForm" enctype="multipart/form-data">
							<div class="mb-3">
								<input type="file" class="form-control" id="fileInput" accept=".txt">
							</div>
							<button type="submit" class="btn btn-primary">
								<span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
								Upload
							</button>
						</form>
					</div>
				</div>

				<!-- File List Section -->
				<div class="card mb-4 animate__animated animate__fadeInUp" style="animation-delay: 0.2s">
					<div class="card-header d-flex justify-content-between align-items-center">
						<span>Files</span>
						<button id="refreshList" class="btn btn-sm btn-outline-secondary">
							<i class="fas fa-sync-alt"></i> Refresh
						</button>
					</div>
					<div class="card-body">
						<div class="file-list">
							<div class="list-group" id="fileList">
								{% for file in files %}
								<div class="list-group-item animate__animated animate__fadeIn">
									<div class="form-check d-flex justify-content-between align-items-center">
										<div>
											<input class="form-check-input file-checkbox" type="checkbox" value="{{ file }}" id="file-{{ loop.index }}">
											<label class="form-check-label" for="file-{{ loop.index }}">
												{{ file }}
											</label>
										</div>
										<button class="btn btn-danger btn-sm delete-btn" data-filename="{{ file }}">Delete</button>
									</div>
								</div>
								{% endfor %}
							</div>
						</div>
					</div>
				</div>

				<!-- Status Check Section -->
				<div class="card mb-4 animate__animated animate__fadeInUp" style="animation-delay: 0.4s">
					<div class="card-header">Status Check</div>
					<div class="card-body">
						<div class="form-check mb-3">
							<input class="form-check-input" type="checkbox" id="ignoreDate" checked>
							<label class="form-check-label" for="ignoreDate">
								Ignore Date
							</label>
						</div>
						<button id="checkStatus" class="btn btn-primary me-2">Check Status</button>
						<button id="downloadResults" class="btn btn-success">Download Results</button>
					</div>
				</div>
			</div>
		</div>
	</div>

						


					</div>

					<!-- Right Column - Visualizations -->
					<div class="col-md-10">
						<!-- Stats Cards -->
						<div class="row mb-4">
							<div class="col-md-1-7">
								<div class="card stat-card total-parts">
									<div class="card-body">
										<div class="d-flex justify-content-between align-items-center">
											<div>
												<h6 class="card-subtitle mb-2">Total Parts</h6>
												<h2 class="card-title mb-0" id="totalPartsCount">0</h2>
											</div>
											<i class="fas fa-boxes stat-icon"></i>
										</div>
									</div>
								</div>
							</div>
							<div class="col-md-1-7">
								<div class="card stat-card expired-parts">
									<div class="card-body">
										<div class="d-flex justify-content-between align-items-center">
											<div>
												<h6 class="card-subtitle mb-2">Expired Parts</h6>
												<h2 class="card-title mb-0" id="expiredPartsCount">0</h2>
											</div>
											<i class="fas fa-exclamation-circle stat-icon"></i>
										</div>
									</div>
								</div>
							</div>
							<div class="col-md-1-7">
								<div class="card stat-card active-parts">
									<div class="card-body">
										<div class="d-flex justify-content-between align-items-center">
											<div>
												<h6 class="card-subtitle mb-2">Active Parts</h6>
												<h2 class="card-title mb-0" id="activePartsCount">0</h2>
											</div>
											<i class="fas fa-check-circle stat-icon"></i>
										</div>
									</div>
								</div>
							</div>
							<div class="col-md-1-7">
								<div class="card stat-card error-parts">
									<div class="card-body">
										<div class="d-flex justify-content-between align-items-center">
											<div>
												<h6 class="card-subtitle mb-2">Error Parts</h6>
												<h2 class="card-title mb-0" id="errorPartsCount">0</h2>
											</div>
											<i class="fas fa-times-circle stat-icon"></i>
										</div>
									</div>
								</div>
							</div>
							<div class="col-md-1-7">
								<div class="card stat-card missing-parts">
									<div class="card-body">
										<div class="d-flex justify-content-between align-items-center">
											<div>
												<h6 class="card-subtitle mb-2">Missing Parts</h6>
												<h2 class="card-title mb-0" id="missingPartsCount">0</h2>
											</div>
											<i class="fas fa-exclamation-circle stat-icon"></i>
										</div>
									</div>
								</div>
							</div>
							<div class="col-md-1-7">
								<div class="card stat-card module-count">
									<div class="card-body">
										<div class="d-flex justify-content-between align-items-center">
											<div>
												<h6 class="card-subtitle mb-2">Modules Count</h6>
												<h2 class="card-title mb-0" id="modulesCount">0</h2>
											</div>
											<i class="fas fa-address-book stat-icon"></i>
										</div>
									</div>
								</div>
							</div>
							<div class="col-md-1-7">
								<div class="card stat-card issue-module-count">
									<div class="card-body">
										<div class="d-flex justify-content-between align-items-center">
											<div>
												<h6 class="card-subtitle mb-2">Issue Modules</h6>
												<h2 class="card-title mb-0" id="IssuemodulesCount">0</h2>
											</div>
											<i class="fas fa-minus-circle stat-icon"></i>
										</div>
									</div>
								</div>
							</div>
						</div>


						<!-- Charts 
						<div class="row mb-4">
							<div class="col-md-6">
								<div class="position-relative h-100">
									<div id="statusPieChart" class="chart-container"></div>
									<div class="chart-loading" style="display: none;">
										<div class="spinner-border text-primary" role="status">
											<span class="visually-hidden">Loading...</span>
										</div>
									</div>
								</div>
							</div>
							<div class="col-md-6">
								<div class="position-relative h-100">
									<div id="moduleBarChart" class="chart-container"></div>
									<div class="chart-loading" style="display: none;">
										<div class="spinner-border text-primary" role="status">
											<span class="visually-hidden">Loading...</span>
										</div>
									</div>
								</div>
							</div>
						</div>

						<div class="row mb-4">
							<div class="col-md-12">
								<div class="position-relative h-100">
									<div id="prtyColumnChart" class="chart-container"></div>
									<div class="chart-loading" style="display: none;">
										<div class="spinner-border text-primary" role="status">
											<span class="visually-hidden">Loading...</span>
										</div>
									</div>
								</div>
							</div>
						</div>

						<div class="row mb-4">
							<div class="col-md-6">
								<div class="position-relative h-100">
									<div id="tableNameChart" class="chart-container"></div>
									<div class="chart-loading" style=>
										<div class="spinner-border text-primary" role="status">
											<span class="visually-hidden">Loading...</span>
										</div>
									</div>
								</div>
							</div>
							<div class="col-md-6">
								<div class="position-relative h-100">
									<div id="isExpiredChart" class="chart-container"></div>
									<div class="chart-loading" style="display: none;">
										<div class="spinner-border text-primary" role="status">
											<span class="visually-hidden">Loading...</span>
										</div>
									</div>
								</div>
							</div>
						</div>

						<div class="row mb-4">
							<div class="col-md-12">
								<div class="position-relative h-100">
									<div id="dataTableChart" class="chart-container"></div>
									<div class="chart-loading" style="display: none;">
										<div class="spinner-border text-primary" role="status">
											<span class="visually-hidden">Loading...</span>
										</div>
									</div>
								</div>
							</div>
						</div>

						<div class="row">
							<div class="col-md-12">
								<div class="position-relative h-100">
									<div id="timelineChart" class="chart-container"></div>
									<div class="chart-loading" style="display: none;">
										<div class="spinner-border text-primary" role="status">
											<span class="visually-hidden">Loading...</span>
										</div>
									</div>
								</div>
							</div>
						</div>
						-->

</div>


			
</div>

		</div>
	</div>
	<script>
		let csvData = [];

		function showNotification(message, type = 'success') {
			const notification = document.getElementById('notification');
			notification.className = `alert alert-${type} animate__animated animate__fadeInRight`;
			notification.textContent = message;
			notification.style.display = 'block';
			setTimeout(() => {
				notification.classList.remove('animate__fadeInRight');
				notification.classList.add('animate__fadeOutRight');
				setTimeout(() => {
					notification.style.display = 'none';
				}, 500);
			}, 3000);
		}

		function showLoading() {
			document.querySelector('.loading').style.display = 'flex';
		}

		function hideLoading() {
			document.querySelector('.loading').style.display = 'none';
		}

		function loadCSVData() {
			showLoading();
			fetch('/results.csv')
				.then(response => {
					if (!response.ok) {
						throw new Error('Failed to load CSV file');
					}
					return response.text();
				})
				.then(text => {
					csvData = Papa.parse(text, { 
						header: true,
						skipEmptyLines: true,
						transformHeader: h => h.trim().toLowerCase()
					}).data;
					updateCharts();
					hideLoading();
				})
				.catch(error => {
					console.error('Error loading CSV:', error);
					showNotification('Error loading data: ' + error.message, 'danger');
					hideLoading();
				});
		}

		// Login functionality
		const loginModal = new bootstrap.Modal(document.getElementById('loginModal'), {
			backdrop: 'static',
			keyboard: false
		});

		function checkLoginStatus() {
			const loginData = localStorage.getItem('loginData');
			if (loginData) {
				const { timestamp } = JSON.parse(loginData);
				const oneDayInMs = 24 * 60 * 60 * 1000;
				if (Date.now() - timestamp < oneDayInMs) {
					return true;
				}
				localStorage.removeItem('loginData');
			}
			return false;
		}

		// Event Listeners
		document.addEventListener('DOMContentLoaded', () => {
			if (checkLoginStatus()) {
				document.querySelector('.container-fluid').style.display = 'block';
				//loadCSVData();
			} else {
				loginModal.show();
			}
		});

		document.getElementById('loginForm').addEventListener('submit', (e) => {
			e.preventDefault();
			const username = document.getElementById('username').value;
			const password = document.getElementById('password').value;
			
			if (username === 'WDA' && password === 'admin') {
				localStorage.setItem('loginData', JSON.stringify({
					timestamp: Date.now()
				}));
				loginModal.hide();
				document.querySelector('.container-fluid').style.display = 'block';
				loadCSVData();
			} else {
				document.getElementById('loginError').style.display = 'block';
			}
		});

		// File operations event listeners
		document.getElementById('uploadForm').addEventListener('submit', async (e) => {
			e.preventDefault();
			const formData = new FormData();
			const fileInput = document.getElementById('fileInput');
			const submitBtn = e.target.querySelector('button[type="submit"]');
			const spinner = submitBtn.querySelector('.spinner-border');
			
			formData.append('file', fileInput.files[0]);
			
			try {
				spinner.classList.remove('d-none');
				submitBtn.disabled = true;
				showLoading();

				const response = await fetch('/upload', {
					method: 'POST',
					body: formData
				});
				const result = await response.json();
				
				if (response.ok) {
					showNotification('File uploaded successfully');
					location.reload();
				} else {
					showNotification(result.error, 'danger');
				}
			} catch (error) {
				showNotification('Error uploading file', 'danger');
			} finally {
				spinner.classList.add('d-none');
				submitBtn.disabled = false;
				hideLoading();
			}
		});

		document.querySelectorAll('.delete-btn').forEach(button => {
			button.addEventListener('click', async () => {
				const filename = button.dataset.filename;
				if (confirm(`Delete ${filename}?`)) {
					try {
						showLoading();
						const response = await fetch(`/delete/${filename}`, {
							method: 'POST'
						});
						const result = await response.json();
						
						if (response.ok) {
							button.closest('.list-group-item').classList.add('animate__fadeOutRight');
							setTimeout(() => {
								location.reload();
							}, 500);
							showNotification('File deleted successfully');
						} else {
							showNotification(result.error, 'danger');
						}
					} catch (error) {
						showNotification('Error deleting file', 'danger');
					} finally {
						hideLoading();
					}
				}
			})
		});




		




		// Function to handle data updates

		function updateCharts() {
			if (!csvData || csvData.length === 0) {
				return;
			}

			// Show loading indicators before updating charts
			const chartLoadings = document.querySelectorAll('.chart-loading');
			chartLoadings.forEach(loading => loading.style.display = 'flex');

			try {
				// Update stat cards
				const totalParts = csvData.length;
				const expiredParts = csvData.filter(row => row.is_expired === "True").length;
				const activeParts = csvData.filter(row => row.is_expired === "False").length;
				const errorParts = csvData.filter(row => 
					row.status === "Error" || 
					row.status === "Proxy" || 
					row.status === "Incomplete Download"
				).length;
				const missingParts = csvData.filter(row => row.table_name === "not run").length;
				const uniqueModules = new Set(csvData.map(row => row.module));

				// Update stat cards
				document.getElementById('totalPartsCount').textContent = totalParts;
				document.getElementById('expiredPartsCount').textContent = expiredParts;
				document.getElementById('activePartsCount').textContent = activeParts;
				document.getElementById('errorPartsCount').textContent = errorParts;
				document.getElementById('missingPartsCount').textContent = missingParts;
				document.getElementById('modulesCount').textContent = uniqueModules.size;

				// Common chart layout and config
				const commonLayout = {
					height: 450,
					margin: { t: 30, b: 50, l: 50, r: 20 },
					paper_bgcolor: 'white',
					plot_bgcolor: 'white',
					font: { family: 'Arial', size: 12, color: '#506784' },
					showlegend: true,
					legend: { orientation: 'h', y: -0.2 }
				};

				const config = {
					responsive: true,
					displayModeBar: true,
					displaylogo: false,
					modeBarButtonsToRemove: ['lasso2d', 'select2d']
				};

				// Status Pie Chart
				const statusCounts = {};
				csvData.forEach(row => {
					statusCounts[row.status] = (statusCounts[row.status] || 0) + 1;
				});

				Plotly.newPlot('statusPieChart', [{
					values: Object.values(statusCounts),
					labels: Object.keys(statusCounts),
					type: 'pie',
					hole: 0.4,
					textinfo: 'label+percent'
				}], {
					...commonLayout,
					title: 'Status Distribution'
				}, config);

				// Module Bar Chart
				const moduleCounts = {};
				csvData.forEach(row => {
					moduleCounts[row.module] = (moduleCounts[row.module] || 0) + 1;
				});

				const sortedModuleCounts = Object.entries(moduleCounts)
					.sort((a, b) => b[1] - a[1]);

				Plotly.newPlot('moduleBarChart', [{
					x: sortedModuleCounts.map(item => item[0]),
					y: sortedModuleCounts.map(item => item[1]),
					type: 'bar',
					marker: { color: 'rgb(55, 83, 109)' }
				}], {
					...commonLayout,
					title: 'Module Distribution',
					xaxis: { tickangle: -45, automargin: true }
				}, config);

				// PRTY Column Chart
				const prtyCounts = {};
				csvData.forEach(row => {
					prtyCounts[row.prty] = (prtyCounts[row.prty] || 0) + 1;
				});

				Plotly.newPlot('prtyColumnChart', [{
					x: Object.keys(prtyCounts),
					y: Object.values(prtyCounts),
					type: 'bar',
					marker: { color: 'rgb(26, 118, 255)' }
				}], {
					...commonLayout,
					title: 'PRTY Distribution',
					xaxis: { tickangle: -45, automargin: true }
				}, config);

				// Table Name Chart
				const tableNameCounts = {};
				csvData.forEach(row => {
					tableNameCounts[row.table_name] = (tableNameCounts[row.table_name] || 0) + 1;
				});

				Plotly.newPlot('tableNameChart', [{
					x: Object.keys(tableNameCounts),
					y: Object.values(tableNameCounts),
					type: 'bar',
					marker: { color: 'rgb(142, 68, 173)' }
				}], {
					...commonLayout,
					title: 'Table Name Distribution',
					xaxis: { tickangle: -45, automargin: true }
				}, config);

				// Is Expired Pie Chart
				const isExpiredCounts = {
					'Expired': expiredParts,
					'Not Expired': activeParts
				};

				Plotly.newPlot('isExpiredChart', [{
					values: Object.values(isExpiredCounts),
					labels: Object.keys(isExpiredCounts),
					type: 'pie',
					hole: 0.4,
					textinfo: 'label+percent',
					marker: { colors: ['#e74c3c', '#2ecc71'] }
				}], {
					...commonLayout,
					title: 'Expiration Status'
				}, config);

				// Timeline Chart
				const timelineData = csvData.reduce((acc, row) => {
					const date = row.last_run_date;
					acc[date] = (acc[date] || 0) + 1;
					return acc;
				}, {});

				const sortedDates = Object.keys(timelineData).sort();

				Plotly.newPlot('timelineChart', [{
					x: sortedDates,
					y: sortedDates.map(date => timelineData[date]),
					type: 'scatter',
					mode: 'lines+markers',
					line: { color: '#2ecc71' },
					marker: { color: '#27ae60' }
				}], {
					...commonLayout,
					title: 'Timeline',
					xaxis: { title: 'Date', tickangle: -45 },
					yaxis: { title: 'Count' }
				}, config);

				// Data Table Chart
				const tableData = [{
					type: 'table',
					columnwidth: Object.keys(csvData[0]).map(key => {
						const maxLength = Math.max(...csvData.map(row => String(row[key] || '').length));
						if (maxLength < 10) return 150;
						if (maxLength < 20) return 200;
						if (maxLength < 30) return 300;
						return 400;
					}),
					header: {
						values: Object.keys(csvData[0]).map(key => key.toUpperCase()),
						align: 'center',
						line: { width: 1.5, color: '#506784' },
						fill: { color: '#2c3e50' },
						font: { family: 'Arial', size: 11, color: 'white', weight: 'bold' },
						height: 40
					},
					cells: {
						values: Object.keys(csvData[0]).map(key => 
							csvData.map(row => {
								const value = row[key];
								if (value === null || value === undefined) return '-';
								const strValue = String(value);
								return strValue.length > 100 ? strValue.substring(0, 50) + '...' : strValue;
							})
						),
						align: Object.keys(csvData[0]).map(key => 
							['status', 'prty', 'is_expired'].includes(key) ? 'center' : 'left'
						),
						line: { color: '#506784', width: 1 },
						fill: { color: [['rgba(250, 250, 250, 1)', 'rgba(245, 245, 245, 1)'].slice(0, csvData.length)] },
						font: { family: 'Arial', size: 11, color: '#506784' },
						height: 25
					}
				}];

				const tableLayout = {
					...commonLayout,
					height: 700,
					margin: { t: 30, b: 30, l: 10, r: 10 },
					title: 'Data Table'
				};

				Plotly.newPlot('dataTableChart', tableData, tableLayout, {
					...config,
					displayModeBar: false
				});

				// Trigger window resize for proper rendering
				setTimeout(() => {
					window.dispatchEvent(new Event('resize'));
				}, 100);

			} catch (error) {
				console.error('Error updating charts:', error);
				showNotification('Error updating charts', 'danger');
			} finally {
				chartLoadings.forEach(loading => loading.style.display = 'none');
			}
		}





		// Refresh list handler
		document.getElementById('refreshList').addEventListener('click', async () => {
			try {
				showLoading();
				const response = await fetch('/refresh-files');
				const result = await response.json();
				
				if (response.ok) {
					location.reload();
				} else {
					showNotification(result.error, 'danger');
				}
			} catch (error) {
				showNotification('Error refreshing files', 'danger');
			} finally {
				hideLoading();
			}
		});

		// Initialize data loading when DOM is ready
		document.addEventListener('DOMContentLoaded', loadCSVData);

		// File Upload Handler
		document.getElementById('uploadForm').addEventListener('submit', async (e) => {
			e.preventDefault();
			const formData = new FormData();
			const fileInput = document.getElementById('fileInput');
			const submitBtn = e.target.querySelector('button[type="submit"]');
			const spinner = submitBtn.querySelector('.spinner-border');
			
			formData.append('file', fileInput.files[0]);
			
			try {
				spinner.classList.remove('d-none');
				submitBtn.disabled = true;
				showLoading();

				const response = await fetch('/upload', {
					method: 'POST',
					body: formData
				});
				const result = await response.json();
				
				if (response.ok) {
					showNotification('File uploaded successfully');
					location.reload();
				} else {
					showNotification(result.error, 'danger');
				}
			} catch (error) {
				showNotification('Error uploading file', 'danger');
			} finally {
				spinner.classList.add('d-none');
				submitBtn.disabled = false;
				hideLoading();
			}
		});

		// Delete File Handler
		document.querySelectorAll('.delete-btn').forEach(button => {
			button.addEventListener('click', async () => {
				const filename = button.dataset.filename;
				if (confirm(`Delete ${filename}?`)) {
					try {
						showLoading();
						const response = await fetch(`/delete/${filename}`, {
							method: 'POST'
						});
						const result = await response.json();
						
						if (response.ok) {
							button.closest('.list-group-item').classList.add('animate__fadeOutRight');
							setTimeout(() => {
								location.reload();
							}, 500);
							showNotification('File deleted successfully');
						} else {
							showNotification(result.error, 'danger');
						}
					} catch (error) {
						showNotification('Error deleting file', 'danger');
					} finally {
						hideLoading();
					}
				}
			});
		});

		// Status Check Handler
		document.getElementById('checkStatus').addEventListener('click', async () => {
			const selectedFiles = Array.from(document.querySelectorAll('.file-checkbox:checked')).map(cb => cb.value);
			const ignoreDate = document.getElementById('ignoreDate').checked;

			try {
				showLoading();
				const response = await fetch('/status', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({
						files: selectedFiles,
						ignore_date: ignoreDate
					})
				});
				const result = await response.json();
				
				if (response.ok) {
					showNotification('Status check completed successfully');
					if (result.data) {
						loadCSVData();
					}
				} else {
					showNotification(result.error, 'danger');
				}
			} catch (error) {
				showNotification('Error checking status', 'danger');
			} finally {
				hideLoading();
			}
		});

		// Download Results Handler
		document.getElementById('downloadResults').addEventListener('click', async () => {
			const selectedFiles = Array.from(document.querySelectorAll('.file-checkbox:checked')).map(cb => cb.value);

			try {
				showLoading();
				const response = await fetch('/download', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({
						files: selectedFiles
					})
				});
				
				if (response.ok) {
					const blob = await response.blob();
					const url = window.URL.createObjectURL(blob);
					const a = document.createElement('a');
					a.href = url;
					a.download = 'results.csv';
					document.body.appendChild(a);
					a.click();
					window.URL.revokeObjectURL(url);
					showNotification('Results downloaded successfully');
					loadCSVData();
				} else {
					const result = await response.json();
					showNotification(result.error, 'danger');
				}
			} catch (error) {
				showNotification('Error downloading results', 'danger');
			} finally {
				hideLoading();
			}
		});


	</script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
</body>
</html>